{% extends 'base.html' %}

{% block content %}

<link rel="stylesheet" href="{{ url_for('static', filename='css/play.css') }}" />


{% if question is none %}
<div class="quiz-container">
  <div class="card">
    <!-- Decorative sparkles -->
    <div class="sparkle" style="top: 10%; left: 20%;"></div>
    <div class="sparkle" style="top: 70%; left: 80%;"></div>
    <div class="sparkle" style="top: 30%; left: 90%;"></div>
    <div class="sparkle" style="top: 80%; left: 10%;"></div>

    <div class="completion-container">
      <h1 class="completion-title">‡∂¥‡∑î‡∑Ñ‡∑î‡∂´‡∑î‡∑Ä ‡∂Ö‡∑Ä‡∑É‡∂±‡∑ä!</h1>
      <p class="completion-desc">‡∂î‡∂∂ ‡∑É‡∑í‡∂∫‡∂Ω‡∑î‡∂∏ ‡∂¥‡∑ä‚Äç‡∂ª‡∑Å‡∑ä‡∂± ‡∑É‡∂∏‡∑ä‡∂¥‡∑ñ‡∂ª‡∑ä‡∂´ ‡∂ö‡∂ª ‡∂á‡∂≠.</p>
      <a href="{{ url_for('kinesthetic.leaderboard') }}" class="btn btn-primary">
        <i class="fa fa-trophy"></i>
        ‡∂¥‡∑ä‚Äç‡∂ª‡∂≠‡∑í‡∂µ‡∂Ω ‡∂∂‡∂Ω‡∂±‡∑ä‡∂±
      </a>
    </div>
  </div>
</div>
{% else %}
<div class="quiz-container">
  <div class="card">
    <!-- Decorative sparkles -->
    <div class="sparkle" style="top: 10%; left: 20%;"></div>
    <div class="sparkle" style="top: 70%; left: 80%;"></div>
    <div class="sparkle" style="top: 30%; left: 90%;"></div>
    <div class="sparkle" style="top: 80%; left: 10%;"></div>

    <!-- Progress indicator with modern style -->
    <div class="progress-container">
      <div class="progress-outer">
        <div class="progress-inner" style="width: {{ ((5 - (remaining_questions or 5)) * 20) }}%">
          <div class="progress-shine"></div>
        </div>
      </div>
      <div class="progress-text">{{ 5 - (remaining_questions or 5) }}/5 Questions</div>
    </div>

    <div class="alert">
      <i class="fa fa-info-circle"></i>
      <span class="alert-text">‡∂≠‡∑Ä ‡∂¥‡∑ä‚Äç‡∂ª‡∑Å‡∑ä‡∂± {{ remaining_questions or 5 }} ‡∂∫‡∑í</span>
    </div>

    <div class="question-content">
      <!-- Main question with HTML content and added colorful styling -->
      <div class="main-question-text">
        {{ question.text|safe }}
      </div>

      <!-- Sub questions in accordion -->
      <div class="sub-questions-container">
        {% for sub_q in question.sub_questions %}
        <div class="sub-question">
          <button class="sub-question-header" onclick="toggleSubQuestion({{ loop.index }})">
            <span class="sub-question-title">{{ sub_q.text }}</span>
            <div class="sub-question-badges">
              <span class="badge badge-primary">‡∂Ω‡∂ö‡∑î‡∂´‡∑î {{ sub_q.points }}</span>
              <span class="badge badge-secondary">‡∂∏‡∂ß‡∑ä‡∂ß‡∂∏ {{ sub_q.difficulty_level }}</span>
            </div>
          </button>

          <div id="subQuestion{{ loop.index }}" class="sub-question-content">
            <form method="POST" action="{{ url_for('kinesthetic.play') }}" class="answer-form"
              enctype="multipart/form-data">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <input type="hidden" name="question_pk" value="{{ question.id }}">
              <input type="hidden" name="answer_method" value="{{ question.answer_method }}">
              <input type="hidden" name="sub_question_id" value="{{ sub_q.id }}">

              <!-- Instructions -->
              {% if sub_q.instructions %}
              <div class="alert alert-info">
                <i class="fa fa-info-circle"></i>
                <span class="alert-text">{{ sub_q.instructions }}</span>
              </div>
              {% endif %}

              <!-- Answer interface based on method -->
              <div class="answer-interface">
                <!-- Method-specific instructions with icons -->
                <h5 class="method-title">
                  {% if question.answer_method == 'abacus' %}
                  <i class="fa fa-calculator" style="color: #6366F1;"></i> ‡∂ú‡∂´‡∂ö ‡∂ª‡∑è‡∂∏‡∑î‡∑Ä (‡∂á‡∂∂‡∂ö‡∑É‡∂∫) ‡∂¥‡∑ô‡∂±‡∑ä‡∑Ä‡∂±‡∑ä‡∂±
                  {% elif question.answer_method == 'analog_clock' %}
                  <i class="fa fa-clock-o" style="color: #6366F1;"></i> ‡∂Ö‡∂±‡∂Ω‡∑ú‡∂ú‡∑ä ‡∂î‡∂ª‡∂Ω‡∑ù‡∑É‡∑î‡∑Ä ‡∂¥‡∑ô‡∂±‡∑ä‡∑Ä‡∂±‡∑ä‡∂±
                  {% else %}
                  <i class="fa fa-desktop" style="color: #6366F1;"></i> ‡∂©‡∑í‡∂¢‡∑í‡∂ß‡∂Ω‡∑ä ‡∂î‡∂ª‡∂Ω‡∑ù‡∑É‡∑î‡∑Ä ‡∂¥‡∑ô‡∂±‡∑ä‡∑Ä‡∂±‡∑ä‡∂±
                  {% endif %}
                </h5>

                <!-- Answer constraints -->
                {% if sub_q.answer_type == 'number' and sub_q.min_value and sub_q.max_value %}
                <!-- <p class="constraint-text">
                  <i class="fa fa-ruler" style="color: #6B7280; margin-right: 5px;"></i>
                  ‡∂Ö‡∂ú‡∂∫ {{ sub_q.min_value }} ‡∑É‡∑Ñ {{ sub_q.max_value }} ‡∂Ö‡∂≠‡∂ª ‡∑Ä‡∑í‡∂∫ ‡∂∫‡∑î‡∂≠‡∑î‡∂∫
                </p> -->
                {% endif %}
                {% if sub_q.answer_type == 'time' and sub_q.time_format %}
                <p class="constraint-text">
                  <i class="fa fa-hourglass-half" style="color: #6B7280; margin-right: 5px;"></i>
                  ‡∑Ä‡∑ö‡∂Ω‡∑è‡∑Ä {{ sub_q.time_format }} ‡∂Ü‡∂ö‡∑ò‡∂≠‡∑í‡∂∫‡∂ß ‡∂¥‡∑ô‡∂±‡∑ä‡∑Ä‡∂±‡∑ä‡∂±
                </p>
                {% endif %}

                <!-- Webcam capture -->
                <div class="webcam-container">
                  <video id="webcam{{ loop.index }}" autoplay playsinline class="webcam-video"></video>
                  <button type="button" class="btn btn-primary mt-3" id="openCamera{{ loop.index }}"
                    onclick="openCamera('webcam{{ loop.index }}', this)">
                    <i class="fa fa-video-camera"></i> ‡∂ö‡∑ê‡∂∏‡∂ª‡∑è‡∑Ä ‡∑Ä‡∑í‡∑Ä‡∑ò‡∂≠ ‡∂ö‡∂ª‡∂±‡∑ä‡∂±
                  </button>
                  <button type="button" class="btn btn-primary mt-3" onclick="captureImage('webcam{{ loop.index }}')"
                    style="display: none;" id="capture{{ loop.index }}">
                    <i class="fa fa-camera"></i> ‡∂¥‡∑í‡∂Ç‡∂≠‡∑ñ‡∂ª‡∂∫ ‡∂ú‡∂±‡∑ä‡∂±
                  </button>
                </div>

                <!-- Submit button -->
                <button type="submit" class="btn btn-success mt-3">
                  <i class="fa fa-paper-plane"></i>‡∂¥‡∑í‡∑Ö‡∑í‡∂≠‡∑î‡∂ª ‡∂∫‡∑Ä‡∂±‡∑ä‡∂±
                </button>
              </div>

              <!-- Hint section -->
              {% if sub_q.hint %}
              <div class="hint-section">
                <button class="btn btn-hint" type="button" onclick="toggleHint({{ loop.index }})">
                  <i class="fa fa-lightbulb-o"></i>‡∂ã‡∂Ø‡∑Ä‡∑ä‡∑Ä‡∂ö‡∑ä ‡∂Ω‡∂∂‡∑è ‡∂ú‡∂±‡∑ä‡∂±
                </button>
                <div id="hint{{ loop.index }}" class="hint-content" style="display: none;">
                  {{ sub_q.hint }}
                </div>
              </div>
              {% endif %}
            </form>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>

<!-- Result Modal -->
<div class="modal-overlay" id="resultModal">
  <div class="result-modal correct-modal" id="resultModalContainer">
    <div class="bg-pattern"></div>
    <div class="modal-header">
      <div class="modal-icon" id="modalIcon">
        <!-- Correct icon (default) -->
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
          stroke-linecap="round" stroke-linejoin="round">
          <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
          <polyline points="22 4 12 14.01 9 11.01"></polyline>
        </svg>
      </div>
      <h3 class="modal-title" id="modalTitle">‡∂±‡∑í‡∑Ä‡∑ê‡∂ª‡∂Ø‡∑í‡∂∫‡∑í!</h3>
    </div>

    <div class="modal-content">
      <div class="result-row">
        <span class="result-label">‡∂î‡∂∂ ‡∂¥‡∑ô‡∂±‡∑ä‡∑Ä‡∑ñ ‡∂¥‡∑í‡∑Ö‡∑í‡∂≠‡∑î‡∂ª</span>
        <span class="result-value" id="userAnswer">6408</span>
      </div>
      <div class="result-row">
        <span class="result-label">‡∂±‡∑í‡∑Ä‡∑ê‡∂ª‡∂Ø‡∑í ‡∂¥‡∑í‡∑Ö‡∑í‡∂≠‡∑î‡∂ª</span>
        <span class="result-value" id="correctAnswer">6408</span>
      </div>

      <div class="modal-message" id="modalMessage">
        <span class="emoji">üéâ</span>
        <span>‡∂ë‡∂∏ ‡∂±‡∑í‡∑É‡∑è ‡∂î‡∂∂‡∑ö ‡∂¥‡∑í‡∑Ö‡∑í‡∂≠‡∑î‡∂ª ‡∂±‡∑í‡∑Ä‡∑ê‡∂ª‡∂Ø‡∑í‡∂∫‡∑í!</span>
        <span class="emoji">üéä</span>
      </div>
    </div>

    <button class="modal-btn" onclick="closeModal()">
      <span class="emoji">üëç</span> ‡∑Ñ‡∂ª‡∑í
    </button>
  </div>
</div>

<!-- JavaScript -->
<script>
  // Sparkle animation
  const card = document.querySelector('.card');
  for (let i = 0; i < 10; i++) {
    const sparkle = document.createElement('div');
    sparkle.classList.add('sparkle');
    sparkle.style.top = Math.random() * 100 + '%';
    sparkle.style.left = Math.random() * 100 + '%';
    sparkle.style.animationDelay = Math.random() * 5 + 's';
    sparkle.style.width = Math.random() * 6 + 4 + 'px';
    sparkle.style.height = sparkle.style.width;
    card.appendChild(sparkle);
  }

  // Toggle sub-question content
  function toggleSubQuestion(index) {
    const content = document.getElementById(`subQuestion${index}`);
    const header = content.previousElementSibling;

    // Close all other active questions
    document.querySelectorAll('.sub-question-content').forEach(item => {
      if (item !== content && item.classList.contains('active')) {
        item.classList.remove('active');
        item.previousElementSibling.classList.remove('active');
      }
    });

    // Toggle current question
    content.classList.toggle('active');
    header.classList.toggle('active');
  }

  // Toggle hint visibility
  function toggleHint(index) {
    const hint = document.getElementById(`hint${index}`);
    hint.style.display = hint.style.display === 'none' ? 'block' : 'none';
  }

  // Webcam functionality
  function initWebcam(webcamId) {
    const video = document.getElementById(webcamId);
    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
      navigator.mediaDevices.getUserMedia({ video: true })
        .then(function (stream) {
          video.srcObject = stream;
          video.play();
        })
        .catch(function (error) {
          console.error("Error accessing webcam:", error);
        });
    }
  }

  // Modified capture image function
  function captureImage(webcamId) {
    console.log(`Capturing from ${webcamId}`);

    // For demonstration, randomly decide if answer is correct (70% chance of correct)
    const isCorrect = Math.random() < 0.7;

    // Show the result modal with appropriate styling
    showResultModal(isCorrect);

    // If correct, create confetti celebration
    if (isCorrect) {
      createConfetti();
    }

    // In a real implementation, you would:
    // 1. Capture the image from webcam
    // 2. Send to server for processing
    // 3. Get result and display in modal
    // 4. Show correct/wrong message based on result
  }

  // Function to show modal with correct/wrong styling
  function showResultModal(isCorrect) {
    const modal = document.getElementById('resultModal');
    const modalContainer = document.getElementById('resultModalContainer');
    const modalIcon = document.getElementById('modalIcon');
    const modalTitle = document.getElementById('modalTitle');
    const modalMessage = document.getElementById('modalMessage');
    const userAnswer = document.getElementById('userAnswer');
    const correctAnswer = document.getElementById('correctAnswer');

    if (isCorrect) {
      // Reset classes and add correct class
      modalContainer.className = 'result-modal correct-modal';

      // Set correct icon
      modalIcon.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
          <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
          <polyline points="22 4 12 14.01 9 11.01"></polyline>
        </svg>
      `;

      // Set correct title with emoji
      modalTitle.innerHTML = 'üåü ‡∂±‡∑í‡∑Ä‡∑ê‡∂ª‡∂Ø‡∑í‡∂∫‡∑í! üåü';

      // Set correct message with emojis
      modalMessage.innerHTML = `
        <span class="emoji">üéâ</span>
        <span>‡∂î‡∂∂‡∑ö ‡∂¥‡∑í‡∑Ö‡∑í‡∂≠‡∑î‡∂ª ‡∂±‡∑í‡∑Ä‡∑ê‡∂ª‡∂Ø‡∑í‡∂∫‡∑í!</span>
        <span class="emoji">üéä</span>
      `;

      // Example answer values
      userAnswer.textContent = '6408';
      correctAnswer.textContent = '6408';
    } else {
      // Reset classes and add wrong class
      modalContainer.className = 'result-modal wrong-modal';

      // Set incorrect icon
      modalIcon.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="15" y1="9" x2="9" y2="15"></line>
          <line x1="9" y1="9" x2="15" y2="15"></line>
        </svg>
      `;

      // Set incorrect title with emoji
      modalTitle.innerHTML = 'üòï ‡∂Ö‡∂¥‡∑ú‡∂∫‡∑í! üòï';

      // Set incorrect message with emojis
      modalMessage.innerHTML = `
        <span class="emoji">ü§î</span>
        <span>‡∂î‡∂∂‡∑ö ‡∂¥‡∑í‡∑Ö‡∑í‡∂≠‡∑î‡∂ª ‡∑Ä‡∑ê‡∂ª‡∂Ø‡∑í‡∂∫‡∑í. ‡∂Ö‡∂¥‡∑í ‡∂±‡∑ê‡∑Ä‡∂≠ ‡∑Ä‡∂ª‡∂ö‡∑ä ‡∂ã‡∂≠‡∑ä‡∑É‡∑è‡∑Ñ ‡∂ö‡∂ª‡∂∏‡∑î!</span>
        <span class="emoji">üìö</span>
      `;

      // Example answer values with different values
      userAnswer.textContent = '6409';
      correctAnswer.textContent = '6408';
    }

    // Show modal
    modal.classList.add('active');
  }

  // Function to close modal
  function closeModal() {
    const modal = document.getElementById('resultModal');
    modal.classList.remove('active');

    // Clear any confetti
    document.querySelectorAll('.confetti').forEach(el => el.remove());
  }

  // Function to create confetti celebration
  function createConfetti() {
    const colors = ['#4F46E5', '#A855F7', '#EC4899', '#F59E0B', '#10B981'];
    const confettiCount = 100;

    for (let i = 0; i < confettiCount; i++) {
      const confetti = document.createElement('div');
      confetti.classList.add('confetti');

      const color = colors[Math.floor(Math.random() * colors.length)];
      const size = Math.random() * 10 + 5;
      const shakeOffset = (Math.random() * 50) - 25;
      const fallDuration = (Math.random() * 3) + 2 + 's';
      const shakeDuration = (Math.random() * 0.5) + 0.5 + 's';

      confetti.style.setProperty('--color', color);
      confetti.style.setProperty('--shake-offset', `${shakeOffset}px`);
      confetti.style.setProperty('--fall-duration', fallDuration);
      confetti.style.setProperty('--shake-duration', shakeDuration);

      confetti.style.width = `${size}px`;
      confetti.style.height = `${size}px`;
      confetti.style.backgroundColor = color;
      confetti.style.left = `${Math.random() * 100}%`;

      document.body.appendChild(confetti);

      // Remove confetti after animation completes
      setTimeout(() => {
        if (confetti.parentNode === document.body) {
          document.body.removeChild(confetti);
        }
      }, parseFloat(fallDuration) * 1000);
    }
  }

  // Modified webcam functionality
  function openCamera(webcamId, btnElement) {
    const video = document.getElementById(webcamId);
    const captureBtn = document.getElementById('capture' + webcamId.replace('webcam', ''));

    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
      navigator.mediaDevices.getUserMedia({ video: true })
        .then(function (stream) {
          video.srcObject = stream;
          video.play();
          btnElement.style.display = 'none';  // Hide the open camera button
          captureBtn.style.display = 'block'; // Show the capture button
        })
        .catch(function (error) {
          console.error("Error accessing webcam:", error);
        });
    }
  }

  // Initialize webcams - remove this section since we'll open camera on button click
  window.addEventListener('DOMContentLoaded', function () {
    addPulsingEffect();

    // Add math symbol styling to numbers in the question
    document.querySelectorAll('.main-question-text strong').forEach(element => {
      if (!isNaN(element.textContent) && element.textContent.length <= 2) {
        element.classList.add('math-symbol');
      }
    });
  });

  // Add pulsing effect to important elements
  function addPulsingEffect() {
    document.querySelectorAll('.btn-success').forEach(btn => {
      btn.classList.add('pulse-subtle');
    });
  }
</script>
{% endif %}
{% endblock %}